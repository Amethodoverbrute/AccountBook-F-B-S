# 记账本应用新手指导手把手教学

## 1. 项目概述

### 1.1 项目功能

这是一个基于前后端分离架构的个人记账本应用，主要功能包括：

- 用户注册和登录
- 账单的添加、编辑、删除和查询
- 分类管理（收入和支出分类）
- 账单统计和图表分析
- 搜索和分页功能
- 后台管理系统
  - 管理员角色管理（superAdmin, admin, user）
  - 用户管理（查看、修改角色、删除）
  - 系统统计（总用户数、总账单数、日活跃用户）
  - 角色权限控制
- 统一的样式设计
- 代码格式化工具配置（Prettier + ESLint）

### 1.2 技术栈

| 类别     | 技术       | 版本  | 用途        |
| -------- | ---------- | ----- | ----------- |
| **前端** | Vue.js     | 3.x   | 前端框架    |
|          | Vite       | 7.x   | 构建工具    |
|          | Vue Router | 4.x   | 路由管理    |
|          | Axios      | 1.x   | HTTP 客户端 |
|          | ECharts    | 6.x   | 图表库      |
| **后端** | Node.js    | 16.x+ | 运行环境    |
|          | Express    | 4.x   | Web 框架    |
|          | MongoDB    | 9.x   | 数据库      |
|          | Mongoose   | 9.x   | MongoDB ODM |
|          | JWT        | 9.x   | 身份认证    |
|          | Swagger    | 6.x   | API 文档    |

### 1.3 项目架构

采用前后端分离架构：

- **前端**：位于 `frontend/` 目录，负责用户界面和交互
- **后端**：位于 `backend/` 目录，负责 API 服务和数据管理
- **通信方式**：通过 RESTful API 进行数据交互

## 2. 环境搭建

### 2.1 安装 Node.js

1. 访问 [Node.js 官网](https://nodejs.org/)
2. 下载并安装 LTS 版本（建议 16.x 或更高）
3. 验证安装：打开命令行，输入 `node -v`
   和 `npm -v`，能看到版本号则安装成功

### 2.2 安装 MongoDB

1. 访问 [MongoDB 官网](https://www.mongodb.com/)
2. 下载并安装 MongoDB Community Server
3. 启动 MongoDB 服务
4. 验证安装：打开命令行，输入 `mongosh`，能进入 MongoDB shell 则安装成功

### 2.3 安装 VS Code

1. 访问 [VS Code 官网](https://code.visualstudio.com/)
2. 下载并安装 VS Code
3. 安装推荐扩展：
   - Vue Language Features (Volar)
   - JavaScript (ES6) code snippets
   - Prettier - Code formatter
   - MongoDB for VS Code

## 3. 后端开发（Step by Step）

### 3.1 初始化后端项目

1. 创建项目根目录：

   ```bash
   mkdir account-book
   cd account-book
   ```

2. 创建后端目录并初始化：

   ```bash
   mkdir backend
   cd backend
   npm init -y
   ```

3. 安装核心依赖：

   ```bash
   npm install express mongoose jsonwebtoken cors dotenv moment winston swagger-jsdoc swagger-ui-express
   ```

4. 安装开发依赖：
   ```bash
   npm install nodemon --save-dev
   ```

### 3.2 配置文件设置

1. 创建`.env`文件，配置环境变量：

   ```env
   PORT=3000
   DB_HOST=localhost
   DB_PORT=27017
   DB_NAME=account-book
   SECRET=your_jwt_secret_key
   ```

2. 创建`config.js`文件，统一管理配置：

   ```javascript
   require("dotenv").config();

   module.exports = {
     PORT: process.env.PORT || 3000,
     DB_HOST: process.env.DB_HOST || "localhost",
     DB_PORT: process.env.DB_PORT || 27017,
     DB_NAME: process.env.DB_NAME || "account-book",
     SECRET: process.env.SECRET || "default_secret_key",
   };
   ```

### 3.3 数据库连接

1. 创建`db.js`文件，配置 MongoDB 连接：

   ```javascript
   const mongoose = require("mongoose");
   const { DB_HOST, DB_PORT, DB_NAME } = require("./config");

   const connectDB = async () => {
     try {
       await mongoose.connect(`mongodb://${DB_HOST}:${DB_PORT}/${DB_NAME}`);
       console.log("MongoDB连接成功");
     } catch (error) {
       console.error("MongoDB连接失败:", error);
       process.exit(1);
     }
   };

   module.exports = connectDB;
   ```

### 3.4 模型设计

1. 创建`models`目录，用于存放数据模型

2. 创建`userModel.js`：

   ```javascript
   const mongoose = require("mongoose");

   const UserSchema = new mongoose.Schema({
     username: {
       type: String,
       required: true,
       unique: true,
     },
     password: {
       type: String,
       required: true,
     },
   });

   module.exports = mongoose.model("User", UserSchema);
   ```

3. 创建`categoryModel.js`：

   ```javascript
   const mongoose = require("mongoose");

   const CategorySchema = new mongoose.Schema({
     name: {
       type: String,
       required: true,
     },
     type: {
       type: String,
       enum: ["income", "expense"],
       required: true,
     },
     userId: {
       type: mongoose.Schema.Types.ObjectId,
       ref: "User",
       required: true,
     },
   });

   module.exports = mongoose.model("Category", CategorySchema);
   ```

4. 创建`accountModel.js`：

   ```javascript
   const mongoose = require("mongoose");

   const AccountSchema = new mongoose.Schema({
     title: {
       type: String,
       required: true,
     },
     amount: {
       type: Number,
       required: true,
     },
     type: {
       type: String,
       enum: ["income", "expense"],
       required: true,
     },
     time: {
       type: Date,
       default: Date.now,
     },
     categoryId: {
       type: mongoose.Schema.Types.ObjectId,
       ref: "Category",
       required: true,
     },
     userId: {
       type: mongoose.Schema.Types.ObjectId,
       ref: "User",
       required: true,
     },
   });

   module.exports = mongoose.model("Account", AccountSchema);
   ```

5. 更新`userModel.js`，添加角色字段：

   ```javascript
   const mongoose = require("mongoose");

   const UserSchema = new mongoose.Schema({
     username: {
       type: String,
       required: true,
       unique: true,
     },
     password: {
       type: String,
       required: true,
     },
     role: {
       type: String,
       enum: ["superAdmin", "admin", "user"],
       default: "user",
     },
     createdAt: {
       type: Date,
       default: Date.now,
     },
   });

   module.exports = mongoose.model("User", UserSchema);
   ```

### 3.5 中间件开发

1. 创建`middlewares`目录

2. 创建`checkTokenMiddleware.js`，用于 JWT 验证：

   ```javascript
   const jwt = require("jsonwebtoken");
   const { SECRET } = require("../config");

   module.exports = (req, res, next) => {
     const authHeader = req.headers.authorization;
     if (!authHeader) {
       return res.status(401).json({ code: "401", msg: "未授权" });
     }

     const token = authHeader.split(" ")[1];

     try {
       const decoded = jwt.verify(token, SECRET);
       req.user = decoded;
       next();
     } catch (error) {
       return res.status(401).json({ code: "401", msg: "无效的token" });
     }
   };
   ```

3. 创建`checkAdminMiddleware.js`，用于管理员权限验证：

   ```javascript
   const User = require("../models/userModel");

   module.exports = async (req, res, next) => {
     try {
       const user = await User.findById(req.user.userId);
       if (!user || (user.role !== "admin" && user.role !== "superAdmin")) {
         return res
           .status(403)
           .json({ code: "403", msg: "没有权限访问此资源" });
       }
       next();
     } catch (error) {
       return res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   };
   ```

4. 创建`checkSuperAdminMiddleware.js`，用于超级管理员权限验证：

   ```javascript
   const User = require("../models/userModel");

   module.exports = async (req, res, next) => {
     try {
       const user = await User.findById(req.user.userId);
       if (!user || user.role !== "superAdmin") {
         return res
           .status(403)
           .json({ code: "403", msg: "只有超级管理员可以访问此资源" });
       }
       next();
     } catch (error) {
       return res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   };
   ```

### 3.6 API 路由实现

1. 创建`routes/api`目录

2. 创建`auth.js`，实现认证相关 API：

   ```javascript
   const express = require("express");
   const router = express.Router();
   const bcrypt = require("bcrypt");
   const jwt = require("jsonwebtoken");
   const User = require("../../models/userModel");
   const Category = require("../../models/categoryModel");
   const { SECRET } = require("../../config");

   // 用户注册
   router.post("/register", async (req, res) => {
     try {
       const { username, password } = req.body;
       const existingUser = await User.findOne({ username });
       if (existingUser) {
         return res.status(400).json({ code: "400", msg: "用户名已存在" });
       }

       const hashedPassword = await bcrypt.hash(password, 10);
       const newUser = new User({ username, password: hashedPassword });
       await newUser.save();

       // 创建默认分类
       const defaultCategories = [
         { name: "工作", type: "income", userId: newUser._id },
         { name: "生活", type: "income", userId: newUser._id },
         { name: "其他", type: "income", userId: newUser._id },
         { name: "餐饮", type: "expense", userId: newUser._id },
         { name: "交通", type: "expense", userId: newUser._id },
         { name: "购物", type: "expense", userId: newUser._id },
         { name: "娱乐", type: "expense", userId: newUser._id },
         { name: "其他", type: "expense", userId: newUser._id },
       ];
       await Category.insertMany(defaultCategories);

       res.status(201).json({ code: "0000", msg: "注册成功" });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   // 用户登录
   router.post("/login", async (req, res) => {
     try {
       const { username, password } = req.body;
       const user = await User.findOne({ username });
       if (!user) {
         return res.status(400).json({ code: "400", msg: "用户名或密码错误" });
       }

       const isMatch = await bcrypt.compare(password, user.password);
       if (!isMatch) {
         return res.status(400).json({ code: "400", msg: "用户名或密码错误" });
       }

       const token = jwt.sign({ userId: user._id }, SECRET, {
         expiresIn: "1h",
       });
       res.json({ code: "0000", msg: "登录成功", token });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   // 获取当前用户信息
   router.get("/me", (req, res) => {
     res.json({
       code: "0000",
       msg: "获取成功",
       data: { userId: req.user.userId },
     });
   });

   module.exports = router;
   ```

3. 创建`category.js`，实现分类相关 API：

   ```javascript
   const express = require("express");
   const router = express.Router();
   const Category = require("../../models/categoryModel");

   // 获取分类列表
   router.get("/", async (req, res) => {
     try {
       const categories = await Category.find({ userId: req.user.userId });
       res.json({ code: "0000", msg: "获取成功", data: categories });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   module.exports = router;
   ```

4. 创建`account.js`，实现账单相关 API：

   ```javascript
   const express = require("express");
   const router = express.Router();
   const Account = require("../../models/accountModel");

   // 获取账单列表
   router.get("/", async (req, res) => {
     try {
       const { page = 1, pageSize = 10, keyword = "", type = "" } = req.query;
       const query = {
         userId: req.user.userId,
         ...(keyword && { title: { $regex: keyword, $options: "i" } }),
         ...(type && { type }),
       };

       const total = await Account.countDocuments(query);
       const accounts = await Account.find(query)
         .populate("categoryId")
         .sort({ time: -1 })
         .skip((page - 1) * pageSize)
         .limit(Number(pageSize));

       res.json({
         code: "0000",
         msg: "获取成功",
         data: {
           accounts,
           total,
           page: Number(page),
           pageSize: Number(pageSize),
         },
       });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   // 添加账单
   router.post("/", async (req, res) => {
     try {
       const newAccount = new Account({
         ...req.body,
         userId: req.user.userId,
       });
       await newAccount.save();
       res
         .status(201)
         .json({ code: "0000", msg: "添加成功", data: newAccount });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   // 更新账单
   router.patch("/:id", async (req, res) => {
     try {
       const account = await Account.findByIdAndUpdate(
         req.params.id,
         req.body,
         { new: true },
       );
       if (!account) {
         return res.status(404).json({ code: "404", msg: "账单不存在" });
       }
       res.json({ code: "0000", msg: "更新成功", data: account });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   // 删除账单
   router.delete("/:id", async (req, res) => {
     try {
       const account = await Account.findByIdAndDelete(req.params.id);
       if (!account) {
         return res.status(404).json({ code: "404", msg: "账单不存在" });
       }
       res.json({ code: "0000", msg: "删除成功" });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   module.exports = router;
   ```

5. 创建`statistics.js`，实现统计相关 API：

   ```javascript
   const express = require("express");
   const router = express.Router();
   const Account = require("../../models/accountModel");
   const moment = require("moment");

   // 获取统计数据
   router.get("/", async (req, res) => {
     try {
       const { year = moment().year(), month = moment().month() + 1 } =
         req.query;
       const startDate = moment(`${year}-${month}-01`)
         .startOf("month")
         .toDate();
       const endDate = moment(`${year}-${month}-01`).endOf("month").toDate();

       // 总收入
       const totalIncome = await Account.aggregate([
         {
           $match: {
             userId: req.user.userId,
             type: "income",
             time: { $gte: startDate, $lte: endDate },
           },
         },
         { $group: { _id: null, total: { $sum: "$amount" } } },
       ]);

       // 总支出
       const totalExpense = await Account.aggregate([
         {
           $match: {
             userId: req.user.userId,
             type: "expense",
             time: { $gte: startDate, $lte: endDate },
           },
         },
         { $group: { _id: null, total: { $sum: "$amount" } } },
       ]);

       // 按分类统计
       const categoryStats = await Account.aggregate([
         {
           $match: {
             userId: req.user.userId,
             time: { $gte: startDate, $lte: endDate },
           },
         },
         {
           $lookup: {
             from: "categories",
             localField: "categoryId",
             foreignField: "_id",
             as: "category",
           },
         },
         { $unwind: "$category" },
         {
           $group: {
             _id: { type: "$type", category: "$category.name" },
             amount: { $sum: "$amount" },
           },
         },
       ]);

       res.json({
         code: "0000",
         msg: "获取成功",
         data: {
           totalIncome: totalIncome[0]?.total || 0,
           totalExpense: totalExpense[0]?.total || 0,
           balance:
             (totalIncome[0]?.total || 0) - (totalExpense[0]?.total || 0),
           categoryStats,
         },
       });
     } catch (error) {
       res.status(500).json({ code: "500", msg: "服务器错误" });
     }
   });

   module.exports = router;
   ```

6. 创建`admin.js`，实现管理员相关 API：

   ```javascript
   const express = require("express");
   const router = express.Router();
   const User = require("../../models/userModel");
   const Account = require("../../models/accountModel");

   // 导入中间件
   const checkAdminMiddleware = require("../../middlewares/checkAdminMiddleware");
   const checkSuperAdminMiddleware = require("../../middlewares/checkSuperAdminMiddleware");

   // 获取用户列表（分页、搜索、按角色排序）
   router.get("/admin/users", checkAdminMiddleware, async (req, res) => {
     try {
       const { page = 1, pageSize = 10, search = "" } = req.query;

       // 构建搜索条件
       const searchCondition = search
         ? { username: { $regex: search, $options: "i" } }
         : {};

       // 查询总数量
       const total = await User.countDocuments(searchCondition);

       // 使用aggregate实现按角色优先级排序：superAdmin > admin > user，然后按创建时间倒序
       const users = await User.aggregate([
         // 匹配搜索条件
         { $match: searchCondition },
         // 排除密码字段
         { $project: { password: 0 } },
         // 添加排序优先级字段
         {
           $addFields: {
             rolePriority: {
               $switch: {
                 branches: [
                   { case: { $eq: ["$role", "superAdmin"] }, then: 3 },
                   { case: { $eq: ["$role", "admin"] }, then: 2 },
                   { case: { $eq: ["$role", "user"] }, then: 1 },
                 ],
                 default: 0,
               },
             },
           },
         },
         // 按优先级降序，创建时间倒序排序
         { $sort: { rolePriority: -1, createdAt: -1 } },
         // 分页
         { $skip: (page - 1) * pageSize },
         { $limit: Number(pageSize) },
       ]);

       res.json({
         code: "0000",
         msg: "获取成功",
         data: {
           users,
           total,
           page: Number(page),
           pageSize: Number(pageSize),
         },
       });
     } catch (error) {
       res
         .status(500)
         .json({ code: "500", msg: "获取用户列表失败，服务器错误" });
     }
   });

   // 修改用户角色（仅超级管理员可操作）
   router.put(
     "/admin/users/:userId/role",
     checkSuperAdminMiddleware,
     async (req, res) => {
       try {
         const { userId } = req.params;
         const { role } = req.body;

         // 验证角色值
         const validRoles = ["user", "admin", "superAdmin"];
         if (!validRoles.includes(role)) {
           return res.status(400).json({ code: "400", msg: "无效的角色值" });
         }

         // 更新用户角色
         const updatedUser = await User.findByIdAndUpdate(
           userId,
           { role },
           { new: true },
         ).select("-password");

         if (!updatedUser) {
           return res.status(404).json({ code: "404", msg: "用户不存在" });
         }

         res.json({ code: "0000", msg: "修改用户角色成功", data: updatedUser });
       } catch (error) {
         res
           .status(500)
           .json({ code: "500", msg: "修改用户角色失败，服务器错误" });
       }
     },
   );

   // 删除用户（仅超级管理员可操作）
   router.delete(
     "/admin/users/:userId",
     checkSuperAdminMiddleware,
     async (req, res) => {
       try {
         const { userId } = req.params;

         // 检查用户是否存在
         const user = await User.findById(userId);
         if (!user) {
           return res.status(404).json({ code: "404", msg: "用户不存在" });
         }

         // 删除用户
         await User.findByIdAndDelete(userId);

         res.json({ code: "0000", msg: "删除用户成功" });
       } catch (error) {
         res.status(500).json({ code: "500", msg: "删除用户失败，服务器错误" });
       }
     },
   );

   // 获取系统统计数据
   router.get("/admin/statistics", checkAdminMiddleware, async (req, res) => {
     try {
       // 获取总用户数
       const totalUsers = await User.countDocuments();

       // 获取总账单数
       const totalAccounts = await Account.countDocuments();

       // 获取今日活跃用户数（24小时内有登录记录的用户）
       // 注意：这里需要根据实际的登录记录实现，目前暂时返回总用户数的10%
       const todayActiveUsers = Math.ceil(totalUsers * 0.1);

       res.json({
         code: "0000",
         msg: "获取系统统计数据成功",
         data: {
           totalUsers,
           totalAccounts,
           todayActiveUsers,
         },
       });
     } catch (error) {
       res
         .status(500)
         .json({ code: "500", msg: "获取系统统计数据失败，服务器错误" });
     }
   });

   module.exports = router;
   ```

### 3.7 主应用文件

创建`app.js`，整合所有组件：

```javascript
const express = require("express");
const cors = require("cors");
const connectDB = require("./db");
const { PORT } = require("./config");

// 导入路由
const authRouter = require("./routes/api/auth");
const categoryRouter = require("./routes/api/category");
const accountRouter = require("./routes/api/account");
const statisticsRouter = require("./routes/api/statistics");
const adminRouter = require("./routes/api/admin");

// 导入中间件
const checkTokenMiddleware = require("./middlewares/checkTokenMiddleware");

// 连接数据库
connectDB();

const app = express();

// 中间件
app.use(cors());
app.use(express.json());

// Swagger配置
const swaggerJsdoc = require("swagger-jsdoc");
const swaggerUi = require("swagger-ui-express");
const swaggerOptions = {
  definition: {
    openapi: "3.0.0",
    info: {
      title: "记账本API",
      version: "1.0.0",
      description: "记账本应用的API文档",
    },
  },
  apis: ["./routes/api/*.js"],
};
const swaggerDocs = swaggerJsdoc(swaggerOptions);
app.use("/api-docs", swaggerUi.serve, swaggerUi.setup(swaggerDocs));

// 路由
app.use("/api/auth", authRouter);
app.use("/api/categories", checkTokenMiddleware, categoryRouter);
app.use("/api/accounts", checkTokenMiddleware, accountRouter);
app.use("/api/statistics", checkTokenMiddleware, statisticsRouter);
app.use("/api", checkTokenMiddleware, adminRouter);

// 404处理
app.use((req, res) => {
  res.status(404).json({ code: "404", msg: "接口不存在" });
});

// 错误处理
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ code: "500", msg: "服务器错误" });
});

// 启动服务器
app.listen(PORT, () => {
  console.log(`服务器运行在 http://localhost:${PORT}`);
  console.log(`API文档地址: http://localhost:${PORT}/api-docs`);
});
```

### 3.8 配置 package.json 脚本

更新`package.json`中的脚本：

```json
{
  "scripts": {
    "start": "node app.js",
    "dev": "nodemon app.js"
  }
}
```

### 3.9 测试后端服务

启动后端开发服务器：

```bash
npm run dev
```

访问 http://localhost:3000/api-docs 查看 API 文档，测试各接口是否正常工作。

## 4. 前端开发（Step by Step）

### 4.1 初始化前端项目

1. 使用 Vite 创建 Vue 3 项目：

   ```bash
   cd .. # 回到项目根目录
   npm create vite@latest frontend -- --template vue
   cd frontend
   ```

2. 安装核心依赖：
   ```bash
   npm install vue-router@4 axios echarts
   ```

### 4.2 项目结构设置

1. 创建基本目录结构：
   ```
   src/
   ├── assets/          # 静态资源
   ├── components/      # Vue组件
   │   ├── layout/      # 布局组件
   │   ├── pages/       # 页面组件
   │   └── ui/          # UI组件
   ├── router/          # 路由配置
   ├── services/        # API服务
   ├── utils/           # 工具函数
   ├── App.vue          # 根组件
   └── main.js          # 入口文件
   ```

### 4.3 路由配置

1. 创建`router/index.js`：

   ```javascript
   import { createRouter, createWebHistory } from "vue-router";

   // 路由懒加载
   const Login = () => import("../components/pages/Login.vue");
   const Register = () => import("../components/pages/Register.vue");
   const Home = () => import("../components/pages/Home.vue");
   const Statistics = () => import("../components/pages/Statistics.vue");

   // 管理员页面组件
   const AdminLogin = () => import("../components/pages/AdminLogin.vue");
   const AdminDashboard = () =>
     import("../components/pages/AdminDashboard.vue");
   const UserManagement = () =>
     import("../components/pages/UserManagement.vue");
   const SystemStatistics = () =>
     import("../components/pages/SystemStatistics.vue");

   // 导入认证服务，用于检查用户登录状态
   import { authService } from "../services/auth";

   const routes = [
     { path: "/", redirect: "/login" },
     { path: "/login", component: Login },
     { path: "/register", component: Register },
     {
       path: "/home",
       component: Home,
       meta: { requiresAuth: true },
     },
     {
       path: "/statistics",
       component: Statistics,
       meta: { requiresAuth: true },
     },
     // 管理员路由
     {
       path: "/admin/login",
       component: AdminLogin,
     },
     {
       path: "/admin/dashboard",
       component: AdminDashboard,
       meta: { requiresAuth: true, requiresAdmin: true },
     },
     {
       path: "/admin/users",
       component: UserManagement,
       meta: { requiresAuth: true, requiresAdmin: true },
     },
     {
       path: "/admin/statistics",
       component: SystemStatistics,
       meta: { requiresAuth: true, requiresAdmin: true },
     },
   ];

   const router = createRouter({
     history: createWebHistory(),
     routes,
   });

   // 路由守卫
   router.beforeEach(async (to, from, next) => {
     // 检查目标路由是否需要认证
     if (to.meta.requiresAuth) {
       // 检查用户是否登录
       if (!authService.isLoggedIn()) {
         // 需要认证但未登录，跳转到相应的登录页面
         if (to.meta.requiresAdmin) {
           next("/admin/login");
         } else {
           next("/login");
         }
         return;
       }

       // 检查是否需要管理员权限
       if (to.meta.requiresAdmin) {
         try {
           // 获取用户信息
           const userInfo = await authService.getUserInfo();
           // 检查用户角色是否为管理员或超级管理员
           if (userInfo.role !== "admin" && userInfo.role !== "superAdmin") {
             // 没有管理员权限，跳转到普通用户的首页
             next("/home");
             return;
           }
         } catch (error) {
           console.error("获取用户信息失败:", error);
           // 获取用户信息失败，跳转到登录页面
           if (to.meta.requiresAdmin) {
             next("/admin/login");
           } else {
             next("/login");
           }
           return;
         }
       }
     }

     // 允许跳转，继续执行
     next();
   });

   export default router;
   ```

### 4.4 API 服务封装

1. 创建`services/api.js`，封装 Axios：

   ```javascript
   import axios from "axios";

   // 创建Axios实例
   const api = axios.create({
     baseURL: "http://localhost:3000/api",
     timeout: 5000,
   });

   // 请求拦截器
   api.interceptors.request.use(
     (config) => {
       const token = localStorage.getItem("token");
       if (token) {
         config.headers.Authorization = `Bearer ${token}`;
       }
       return config;
     },
     (error) => {
       return Promise.reject(error);
     },
   );

   // 响应拦截器
   api.interceptors.response.use(
     (response) => {
       return response.data;
     },
     (error) => {
       console.error("API请求错误:", error);
       return Promise.reject(error);
     },
   );

   export default api;
   ```

2. 创建`services/auth.js`，封装认证相关 API：

   ```javascript
   import api from "./api";

   // 认证服务对象
   export const authService = {
     // 注册
     register: (data) => {
       return api.post("/auth/register", data);
     },

     // 登录
     login: (data) => {
       return api.post("/auth/login", data);
     },

     // 获取当前用户信息
     getUserInfo: async () => {
       try {
         const response = await api.get("/auth/me");
         return response.data;
       } catch (error) {
         throw error;
       }
     },

     // 检查用户是否已登录
     isLoggedIn: () => {
       return !!localStorage.getItem("token");
     },

     // 退出登录
     logout: () => {
       localStorage.removeItem("token");
     },

     // 保存 token
     saveToken: (token) => {
       localStorage.setItem("token", token);
     },

     // 获取 token
     getToken: () => {
       return localStorage.getItem("token");
     },
   };

   // 导出单个函数，兼容旧代码
   export const register = authService.register;
   export const login = authService.login;
   export const getCurrentUser = authService.getUserInfo;
   ```

3. 创建`services/account.js`，封装账单相关 API：

   ```javascript
   import api from "./api";

   export const getAccounts = (params) => {
     return api.get("/accounts", { params });
   };

   export const addAccount = (data) => {
     return api.post("/accounts", data);
   };

   export const updateAccount = (id, data) => {
     return api.patch(`/accounts/${id}`, data);
   };

   export const deleteAccount = (id) => {
     return api.delete(`/accounts/${id}`);
   };
   ```

4. 创建`services/category.js`，封装分类相关 API：

   ```javascript
   import api from "./api";

   export const getCategories = () => {
     return api.get("/categories");
   };
   ```

5. 创建`services/statistics.js`，封装统计相关 API：

   ```javascript
   import api from "./api";

   export const getStatistics = (params) => {
     return api.get("/statistics", { params });
   };
   ```

6. 创建`services/admin.js`，封装管理员相关 API：

   ```javascript
   import api from "./api";

   // 获取用户列表
   export const getUsers = (params) => {
     return api.get("/admin/users", { params });
   };

   // 修改用户角色
   export const updateUserRole = (userId, role) => {
     return api.put(`/admin/users/${userId}/role`, { role });
   };

   // 删除用户
   export const deleteUser = (userId) => {
     return api.delete(`/admin/users/${userId}`);
   };

   // 获取系统统计数据
   export const getSystemStatistics = () => {
     return api.get("/admin/statistics");
   };
   ```

### 4.5 组件开发

#### 4.5.1 布局组件

1. 创建`components/layout/Header.vue`：

   ```vue
   <template>
     <header class="header">
       <div class="header-content">
         <h1 class="logo">记账本</h1>
         <nav class="nav">
           <router-link to="/home" class="nav-link">首页</router-link>
           <router-link to="/statistics" class="nav-link">统计</router-link>
         </nav>
         <div class="user-info">
           <span class="username">欢迎，用户</span>
           <button @click="logout" class="logout-btn">退出登录</button>
         </div>
       </div>
     </header>
   </template>

   <script setup>
   import { useRouter } from "vue-router";

   const router = useRouter();

   const logout = () => {
     localStorage.removeItem("token");
     router.push("/login");
   };
   </script>

   <style scoped>
   .header {
     background-color: #409eff;
     color: white;
     padding: 0 20px;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
   }

   .header-content {
     display: flex;
     justify-content: space-between;
     align-items: center;
     max-width: 1200px;
     margin: 0 auto;
     height: 60px;
   }

   .logo {
     font-size: 20px;
     margin: 0;
   }

   .nav {
     display: flex;
     gap: 20px;
   }

   .nav-link {
     color: white;
     text-decoration: none;
     padding: 8px 16px;
     border-radius: 4px;
     transition: background-color 0.3s;
   }

   .nav-link:hover {
     background-color: rgba(255, 255, 255, 0.1);
   }

   .user-info {
     display: flex;
     align-items: center;
     gap: 16px;
   }

   .logout-btn {
     background-color: rgba(255, 255, 255, 0.2);
     color: white;
     border: none;
     padding: 6px 12px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .logout-btn:hover {
     background-color: rgba(255, 255, 255, 0.3);
   }
   </style>
   ```

#### 4.5.2 页面组件

1. 创建`components/pages/Login.vue`：

   ```vue
   <template>
     <div class="login-container">
       <div class="login-form">
         <h2>用户登录</h2>
         <form @submit.prevent="handleLogin">
           <div class="form-item">
             <label for="username">用户名</label>
             <input
               type="text"
               id="username"
               v-model="form.username"
               required
               placeholder="请输入用户名"
             />
           </div>
           <div class="form-item">
             <label for="password">密码</label>
             <input
               type="password"
               id="password"
               v-model="form.password"
               required
               placeholder="请输入密码"
             />
           </div>
           <button type="submit" class="login-btn">登录</button>
           <div class="register-link">
             还没有账号？<router-link to="/register">立即注册</router-link>
           </div>
         </form>
       </div>
     </div>
   </template>

   <script setup>
   import { ref } from "vue";
   import { useRouter } from "vue-router";
   import { login } from "../../services/auth";

   const router = useRouter();
   const form = ref({
     username: "",
     password: "",
   });

   const handleLogin = async () => {
     try {
       const res = await login(form.value);
       if (res.code === "0000") {
         localStorage.setItem("token", res.token);
         router.push("/home");
       }
     } catch (error) {
       alert("登录失败，请检查用户名和密码");
     }
   };
   </script>

   <style scoped>
   .login-container {
     display: flex;
     justify-content: center;
     align-items: center;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .login-form {
     background-color: white;
     padding: 40px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     width: 100%;
     max-width: 400px;
   }

   .login-form h2 {
     text-align: center;
     margin-bottom: 30px;
     color: #303133;
   }

   .form-item {
     margin-bottom: 20px;
   }

   .form-item label {
     display: block;
     margin-bottom: 8px;
     color: #606266;
     font-weight: 500;
   }

   .form-item input {
     width: 100%;
     padding: 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
     transition: border-color 0.3s;
   }

   .form-item input:focus {
     outline: none;
     border-color: #409eff;
   }

   .login-btn {
     width: 100%;
     background-color: #409eff;
     color: white;
     border: none;
     padding: 12px;
     border-radius: 4px;
     font-size: 16px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .login-btn:hover {
     background-color: #66b1ff;
   }

   .register-link {
     text-align: center;
     margin-top: 20px;
     color: #606266;
   }

   .register-link a {
     color: #409eff;
     text-decoration: none;
   }

   .register-link a:hover {
     text-decoration: underline;
   }
   </style>
   ```

2. 创建`components/pages/Register.vue`：

   ```vue
   <template>
     <div class="register-container">
       <div class="register-form">
         <h2>用户注册</h2>
         <form @submit.prevent="handleRegister">
           <div class="form-item">
             <label for="username">用户名</label>
             <input
               type="text"
               id="username"
               v-model="form.username"
               required
               placeholder="请输入用户名"
             />
           </div>
           <div class="form-item">
             <label for="password">密码</label>
             <input
               type="password"
               id="password"
               v-model="form.password"
               required
               placeholder="请输入密码"
             />
           </div>
           <div class="form-item">
             <label for="confirmPassword">确认密码</label>
             <input
               type="password"
               id="confirmPassword"
               v-model="form.confirmPassword"
               required
               placeholder="请再次输入密码"
             />
             <span
               v-if="
                 form.password &&
                 form.confirmPassword &&
                 form.password !== form.confirmPassword
               "
               class="error"
             >
               两次密码输入不一致
             </span>
           </div>
           <button
             type="submit"
             class="register-btn"
             :disabled="form.password !== form.confirmPassword"
           >
             注册
           </button>
           <div class="login-link">
             已有账号？<router-link to="/login">立即登录</router-link>
           </div>
         </form>
       </div>
     </div>
   </template>

   <script setup>
   import { ref } from "vue";
   import { useRouter } from "vue-router";
   import { register } from "../../services/auth";

   const router = useRouter();
   const form = ref({
     username: "",
     password: "",
     confirmPassword: "",
   });

   const handleRegister = async () => {
     if (form.value.password !== form.value.confirmPassword) {
       return;
     }

     try {
       const res = await register({
         username: form.value.username,
         password: form.value.password,
       });
       if (res.code === "0000") {
         alert("注册成功，请登录");
         router.push("/login");
       }
     } catch (error) {
       alert("注册失败，请重试");
     }
   };
   </script>

   <style scoped>
   .register-container {
     display: flex;
     justify-content: center;
     align-items: center;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .register-form {
     background-color: white;
     padding: 40px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     width: 100%;
     max-width: 400px;
   }

   .register-form h2 {
     text-align: center;
     margin-bottom: 30px;
     color: #303133;
   }

   .form-item {
     margin-bottom: 20px;
   }

   .form-item label {
     display: block;
     margin-bottom: 8px;
     color: #606266;
     font-weight: 500;
   }

   .form-item input {
     width: 100%;
     padding: 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
     transition: border-color 0.3s;
   }

   .form-item input:focus {
     outline: none;
     border-color: #409eff;
   }

   .error {
     color: #f56c6c;
     font-size: 12px;
     margin-top: 5px;
     display: block;
   }

   .register-btn {
     width: 100%;
     background-color: #67c23a;
     color: white;
     border: none;
     padding: 12px;
     border-radius: 4px;
     font-size: 16px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .register-btn:hover:not(:disabled) {
     background-color: #85ce61;
   }

   .register-btn:disabled {
     background-color: #c0c4cc;
     cursor: not-allowed;
   }

   .login-link {
     text-align: center;
     margin-top: 20px;
     color: #606266;
   }

   .login-link a {
     color: #409eff;
     text-decoration: none;
   }

   .login-link a:hover {
     text-decoration: underline;
   }
   </style>
   ```

3. 创建`components/pages/Home.vue`（简化版，完整版可参考原项目）：

   ```vue
   <template>
     <div class="home-container">
       <Header />
       <main class="main-content">
         <div class="add-account-btn">
           <button @click="showAddForm = true">添加账单</button>
         </div>

         <!-- 账单列表 -->
         <div class="accounts-list">
           <div
             v-for="account in accounts"
             :key="account._id"
             class="account-card"
             :class="account.type"
           >
             <div class="account-info">
               <h3>{{ account.title }}</h3>
               <p class="account-time">{{ formatDate(account.time) }}</p>
             </div>
             <div class="account-amount">
               {{ account.type === "income" ? "+" : "-"
               }}{{ account.amount }} 元
             </div>
             <div class="account-actions">
               <button @click="handleEdit(account)">编辑</button>
               <button @click="handleDelete(account._id)">删除</button>
             </div>
           </div>
         </div>

         <!-- 分页 -->
         <div class="pagination" v-if="total > pageSize">
           <button
             @click="changePage(currentPage - 1)"
             :disabled="currentPage === 1"
           >
             上一页
           </button>
           <span>{{ currentPage }} / {{ totalPages }}</span>
           <button
             @click="changePage(currentPage + 1)"
             :disabled="currentPage === totalPages"
           >
             下一页
           </button>
         </div>
       </main>

       <!-- 添加/编辑表单 -->
       <div class="modal" v-if="showAddForm || showEditForm">
         <div class="modal-content">
           <h3>{{ showEditForm ? "编辑账单" : "添加账单" }}</h3>
           <form @submit.prevent="handleSubmit">
             <div class="form-item">
               <label>标题</label>
               <input type="text" v-model="form.title" required />
             </div>
             <div class="form-item">
               <label>金额</label>
               <input
                 type="number"
                 v-model.number="form.amount"
                 required
                 min="0"
                 step="0.01"
               />
             </div>
             <div class="form-item">
               <label>类型</label>
               <select v-model="form.type" required>
                 <option value="income">收入</option>
                 <option value="expense">支出</option>
               </select>
             </div>
             <div class="form-item">
               <label>分类</label>
               <select v-model="form.categoryId" required>
                 <option
                   v-for="category in filteredCategories"
                   :key="category._id"
                   :value="category._id"
                 >
                   {{ category.name }}
                 </option>
               </select>
             </div>
             <div class="form-item">
               <label>时间</label>
               <input type="datetime-local" v-model="form.time" required />
             </div>
             <div class="modal-actions">
               <button type="button" @click="closeModal">取消</button>
               <button type="submit">保存</button>
             </div>
           </form>
         </div>
       </div>
     </div>
   </template>

   <script setup>
   import { ref, computed, onMounted, watch } from "vue";
   import Header from "../layout/Header.vue";
   import {
     getAccounts,
     addAccount,
     updateAccount,
     deleteAccount,
   } from "../../services/account";
   import { getCategories } from "../../services/category";

   // 状态管理
   const accounts = ref([]);
   const categories = ref([]);
   const total = ref(0);
   const currentPage = ref(1);
   const pageSize = ref(10);
   const showAddForm = ref(false);
   const showEditForm = ref(false);
   const editingId = ref(null);

   // 表单数据
   const form = ref({
     title: "",
     amount: 0,
     type: "expense",
     categoryId: "",
     time: new Date().toISOString().slice(0, 16),
   });

   // 计算属性
   const totalPages = computed(() => Math.ceil(total.value / pageSize.value));
   const filteredCategories = computed(() => {
     return categories.value.filter(
       (category) => category.type === form.value.type,
     );
   });

   // 格式化日期
   const formatDate = (date) => {
     return new Date(date).toLocaleString("zh-CN");
   };

   // 获取账单列表
   const fetchAccounts = async () => {
     try {
       const res = await getAccounts({
         page: currentPage.value,
         pageSize: pageSize.value,
       });
       accounts.value = res.data.accounts;
       total.value = res.data.total;
     } catch (error) {
       console.error("获取账单失败:", error);
     }
   };

   // 获取分类列表
   const fetchCategories = async () => {
     try {
       const res = await getCategories();
       categories.value = res.data;
       if (res.data.length > 0) {
         form.value.categoryId = res.data[0]._id;
       }
     } catch (error) {
       console.error("获取分类失败:", error);
     }
   };

   // 页面加载时获取数据
   onMounted(() => {
     fetchCategories();
     fetchAccounts();
   });

   // 切换类型时更新分类
   watch(
     () => form.value.type,
     () => {
       if (filteredCategories.value.length > 0) {
         form.value.categoryId = filteredCategories.value[0]._id;
       } else {
         form.value.categoryId = "";
       }
     },
   );

   // 分页
   const changePage = (page) => {
     if (page >= 1 && page <= totalPages.value) {
       currentPage.value = page;
       fetchAccounts();
     }
   };

   // 打开添加表单
   const openAddForm = () => {
     showAddForm.value = true;
     showEditForm.value = false;
     resetForm();
   };

   // 关闭模态框
   const closeModal = () => {
     showAddForm.value = false;
     showEditForm.value = false;
     resetForm();
   };

   // 重置表单
   const resetForm = () => {
     form.value = {
       title: "",
       amount: 0,
       type: "expense",
       categoryId: filteredCategories.value[0]?._id || "",
       time: new Date().toISOString().slice(0, 16),
     };
     editingId.value = null;
   };

   // 处理编辑
   const handleEdit = (account) => {
     showEditForm.value = true;
     showAddForm.value = false;
     editingId.value = account._id;

     form.value = {
       title: account.title,
       amount: account.amount,
       type: account.type,
       categoryId: account.categoryId,
       time: new Date(account.time).toISOString().slice(0, 16),
     };
   };

   // 处理删除
   const handleDelete = async (id) => {
     if (confirm("确定要删除这条账单吗？")) {
       try {
         await deleteAccount(id);
         fetchAccounts();
       } catch (error) {
         console.error("删除账单失败:", error);
       }
     }
   };

   // 处理提交
   const handleSubmit = async () => {
     try {
       if (showEditForm && editingId.value) {
         await updateAccount(editingId.value, form.value);
       } else {
         await addAccount(form.value);
       }
       closeModal();
       fetchAccounts();
     } catch (error) {
       console.error("保存账单失败:", error);
     }
   };
   </script>

   <style scoped>
   .home-container {
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .main-content {
     max-width: 1200px;
     margin: 0 auto;
     padding: 20px;
   }

   .add-account-btn {
     margin-bottom: 20px;
     text-align: right;
   }

   .add-account-btn button {
     background-color: #409eff;
     color: white;
     border: none;
     padding: 10px 20px;
     border-radius: 4px;
     cursor: pointer;
     font-size: 16px;
   }

   .add-account-btn button:hover {
     background-color: #66b1ff;
   }

   .accounts-list {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
     gap: 20px;
     margin-bottom: 20px;
   }

   .account-card {
     background-color: white;
     padding: 20px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     display: flex;
     justify-content: space-between;
     align-items: center;
   }

   .account-card.income {
     border-left: 4px solid #67c23a;
   }

   .account-card.expense {
     border-left: 4px solid #f56c6c;
   }

   .account-info h3 {
     margin: 0 0 5px 0;
     color: #303133;
   }

   .account-time {
     margin: 0;
     color: #909399;
     font-size: 14px;
   }

   .account-amount {
     font-size: 20px;
     font-weight: bold;
   }

   .account-card.income .account-amount {
     color: #67c23a;
   }

   .account-card.expense .account-amount {
     color: #f56c6c;
   }

   .account-actions {
     display: flex;
     gap: 10px;
   }

   .account-actions button {
     padding: 5px 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     background-color: white;
     cursor: pointer;
     font-size: 14px;
   }

   .account-actions button:hover {
     background-color: #f5f7fa;
   }

   .pagination {
     display: flex;
     justify-content: center;
     align-items: center;
     gap: 10px;
     margin-top: 20px;
   }

   .pagination button {
     padding: 5px 15px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     background-color: white;
     cursor: pointer;
   }

   .pagination button:hover:not(:disabled) {
     background-color: #f5f7fa;
   }

   .pagination button:disabled {
     cursor: not-allowed;
     color: #c0c4cc;
   }

   .modal {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background-color: rgba(0, 0, 0, 0.5);
     display: flex;
     justify-content: center;
     align-items: center;
     z-index: 1000;
   }

   .modal-content {
     background-color: white;
     padding: 30px;
     border-radius: 8px;
     width: 100%;
     max-width: 500px;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
   }

   .modal-content h3 {
     margin: 0 0 20px 0;
     color: #303133;
   }

   .form-item {
     margin-bottom: 20px;
   }

   .form-item label {
     display: block;
     margin-bottom: 8px;
     color: #606266;
     font-weight: 500;
   }

   .form-item input,
   .form-item select {
     width: 100%;
     padding: 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
   }

   .modal-actions {
     display: flex;
     justify-content: flex-end;
     gap: 10px;
     margin-top: 30px;
   }

   .modal-actions button {
     padding: 10px 20px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     cursor: pointer;
     font-size: 14px;
   }

   .modal-actions button:first-child {
     background-color: white;
     color: #606266;
   }

   .modal-actions button:first-child:hover {
     background-color: #f5f7fa;
   }

   .modal-actions button:last-child {
     background-color: #409eff;
     color: white;
     border-color: #409eff;
   }

   .modal-actions button:last-child:hover {
     background-color: #66b1ff;
   }
   </style>
   ```

4. 创建`components/pages/Statistics.vue`（简化版）：

   ```vue
   <template>
     <div class="statistics-container">
       <Header />
       <main class="main-content">
         <h2>统计分析</h2>

         <!-- 统计概览 -->
         <div class="stats-overview">
           <div class="stat-card">
             <h3>总收入</h3>
             <p class="amount income">{{ totalIncome }} 元</p>
           </div>
           <div class="stat-card">
             <h3>总支出</h3>
             <p class="amount expense">{{ totalExpense }} 元</p>
           </div>
           <div class="stat-card">
             <h3>结余</h3>
             <p class="amount balance">{{ balance }} 元</p>
           </div>
         </div>

         <!-- 图表容器 -->
         <div class="charts-container">
           <div class="chart-item">
             <h3>收支分布</h3>
             <div id="pie-chart" style="width: 100%; height: 400px;"></div>
           </div>
         </div>
       </main>
     </div>
   </template>

   <script setup>
   import { ref, onMounted, watch } from "vue";
   import * as echarts from "echarts";
   import Header from "../layout/Header.vue";
   import { getStatistics } from "../../services/statistics";

   const totalIncome = ref(0);
   const totalExpense = ref(0);
   const balance = ref(0);
   const categoryStats = ref([]);
   let pieChart = null;

   // 获取统计数据
   const fetchStatistics = async () => {
     try {
       const res = await getStatistics();
       if (res.code === "0000") {
         totalIncome.value = res.data.totalIncome;
         totalExpense.value = res.data.totalExpense;
         balance.value = res.data.balance;
         categoryStats.value = res.data.categoryStats;
         initCharts();
       }
     } catch (error) {
       console.error("获取统计数据失败:", error);
     }
   };

   // 初始化图表
   const initCharts = () => {
     // 饼图数据处理
     const pieData = categoryStats.value.map((stat) => ({
       name: stat._id.category,
       value: stat.amount,
     }));

     // 初始化饼图
     const pieChartDom = document.getElementById("pie-chart");
     if (pieChartDom) {
       pieChart = echarts.init(pieChartDom);
       pieChart.setOption({
         tooltip: {
           trigger: "item",
           formatter: "{a} <br/>{b}: {c} ({d}%)",
         },
         legend: {
           orient: "vertical",
           left: "left",
         },
         series: [
           {
             name: "收支分布",
             type: "pie",
             radius: "50%",
             data: pieData,
             emphasis: {
               itemStyle: {
                 shadowBlur: 10,
                 shadowOffsetX: 0,
                 shadowColor: "rgba(0, 0, 0, 0.5)",
               },
             },
           },
         ],
       });
     }
   };

   // 页面加载时获取数据
   onMounted(() => {
     fetchStatistics();

     // 窗口大小变化时重绘图表
     window.addEventListener("resize", () => {
       if (pieChart) {
         pieChart.resize();
       }
     });
   });
   </script>

   <style scoped>
   .statistics-container {
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .main-content {
     max-width: 1200px;
     margin: 0 auto;
     padding: 20px;
   }

   .stats-overview {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 20px;
     margin-bottom: 30px;
   }

   .stat-card {
     background-color: white;
     padding: 20px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     text-align: center;
   }

   .stat-card h3 {
     margin: 0 0 10px 0;
     color: #606266;
     font-size: 16px;
     font-weight: 500;
   }

   .amount {
     font-size: 28px;
     font-weight: bold;
     margin: 0;
   }

   .amount.income {
     color: #67c23a;
   }

   .amount.expense {
     color: #f56c6c;
   }

   .amount.balance {
     color: #409eff;
   }

   .charts-container {
     display: grid;
     grid-template-columns: 1fr;
     gap: 30px;
   }

   .chart-item {
     background-color: white;
     padding: 20px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
   }

   .chart-item h3 {
     margin: 0 0 20px 0;
     color: #303133;
     font-size: 18px;
   }
   </style>
   ```

5. 创建`components/pages/AdminLogin.vue`（管理员登录组件）：

   ```vue
   <template>
     <div class="admin-login-container">
       <div class="admin-login-form">
         <h2>管理员登录</h2>
         <form @submit.prevent="handleLogin">
           <div class="form-item">
             <label for="username">用户名</label>
             <input
               type="text"
               id="username"
               v-model="form.username"
               required
               placeholder="请输入管理员用户名"
             />
           </div>
           <div class="form-item">
             <label for="password">密码</label>
             <input
               type="password"
               id="password"
               v-model="form.password"
               required
               placeholder="请输入管理员密码"
             />
           </div>
           <button type="submit" class="login-btn">登录</button>
         </form>
       </div>
     </div>
   </template>

   <script setup>
   import { ref } from "vue";
   import { useRouter } from "vue-router";
   import { authService } from "../../services/auth";

   const router = useRouter();
   const form = ref({
     username: "",
     password: "",
   });

   const handleLogin = async () => {
     try {
       const res = await authService.login(form.value);
       if (res.code === "0000") {
         authService.saveToken(res.token);

         // 获取用户信息，检查是否为管理员
         const userInfo = await authService.getUserInfo();
         if (userInfo.role === "admin" || userInfo.role === "superAdmin") {
           router.push("/admin/dashboard");
         } else {
           alert("您不是管理员，无法登录后台管理系统");
           authService.logout();
         }
       }
     } catch (error) {
       alert("登录失败，请检查用户名和密码");
     }
   };
   </script>

   <style scoped>
   .admin-login-container {
     display: flex;
     justify-content: center;
     align-items: center;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .admin-login-form {
     background-color: white;
     padding: 40px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     width: 100%;
     max-width: 400px;
   }

   .admin-login-form h2 {
     text-align: center;
     margin-bottom: 30px;
     color: #303133;
   }

   .form-item {
     margin-bottom: 20px;
   }

   .form-item label {
     display: block;
     margin-bottom: 8px;
     color: #606266;
     font-weight: 500;
   }

   .form-item input {
     width: 100%;
     padding: 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
     transition: border-color 0.3s;
   }

   .form-item input:focus {
     outline: none;
     border-color: #409eff;
   }

   .login-btn {
     width: 100%;
     background-color: #409eff;
     color: white;
     border: none;
     padding: 12px;
     border-radius: 4px;
     font-size: 16px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .login-btn:hover {
     background-color: #66b1ff;
   }
   </style>
   ```

6. 创建`components/pages/AdminDashboard.vue`（管理员仪表盘组件）：

   ```vue
   <template>
     <div class="admin-dashboard">
       <!-- 侧边栏 -->
       <aside class="sidebar">
         <div class="sidebar-header">
           <h2>后台管理</h2>
         </div>
         <nav class="sidebar-nav">
           <router-link to="/admin/dashboard" class="nav-item"
             >仪表盘</router-link
           >
           <router-link to="/admin/users" class="nav-item"
             >用户管理</router-link
           >
           <router-link to="/admin/statistics" class="nav-item"
             >系统统计</router-link
           >
         </nav>
       </aside>

       <!-- 主内容区 -->
       <main class="main-content">
         <!-- 顶部导航 -->
         <header class="top-nav">
           <div class="nav-title">
             <h1>仪表盘</h1>
           </div>
           <div class="user-info">
             <span class="username">欢迎，管理员</span>
             <button @click="logout" class="logout-btn">退出登录</button>
           </div>
         </header>

         <!-- 仪表盘内容 -->
         <div class="dashboard-content">
           <h2>欢迎使用后台管理系统</h2>
           <p>这里是管理员仪表盘，您可以管理系统用户和查看系统统计数据。</p>
         </div>
       </main>
     </div>
   </template>

   <script setup>
   import { useRouter } from "vue-router";
   import { authService } from "../../services/auth";

   const router = useRouter();

   const logout = () => {
     authService.logout();
     router.push("/admin/login");
   };
   </script>

   <style scoped>
   .admin-dashboard {
     display: flex;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .sidebar {
     width: 200px;
     background-color: #304156;
     color: white;
     display: flex;
     flex-direction: column;
   }

   .sidebar-header {
     padding: 20px;
     border-bottom: 1px solid #40556a;
   }

   .sidebar-header h2 {
     margin: 0;
     font-size: 18px;
     font-weight: 600;
   }

   .sidebar-nav {
     flex: 1;
     padding: 20px 0;
   }

   .nav-item {
     display: block;
     padding: 12px 20px;
     color: white;
     text-decoration: none;
     transition: background-color 0.3s;
   }

   .nav-item:hover {
     background-color: #40556a;
   }

   .nav-item.router-link-active {
     background-color: #409eff;
   }

   .main-content {
     flex: 1;
     display: flex;
     flex-direction: column;
   }

   .top-nav {
     background-color: white;
     padding: 0 20px;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
     display: flex;
     justify-content: space-between;
     align-items: center;
     height: 60px;
   }

   .nav-title h1 {
     margin: 0;
     font-size: 20px;
     color: #303133;
   }

   .user-info {
     display: flex;
     align-items: center;
     gap: 16px;
   }

   .username {
     color: #606266;
   }

   .logout-btn {
     background-color: #f56c6c;
     color: white;
     border: none;
     padding: 6px 12px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .logout-btn:hover {
     background-color: #f78989;
   }

   .dashboard-content {
     flex: 1;
     padding: 20px;
   }

   .dashboard-content h2 {
     margin-bottom: 10px;
     color: #303133;
   }

   .dashboard-content p {
     color: #606266;
   }
   </style>
   ```

7. 创建`components/pages/UserManagement.vue`（用户管理组件）：

   ```vue
   <template>
     <div class="admin-dashboard">
       <!-- 侧边栏 -->
       <aside class="sidebar">
         <div class="sidebar-header">
           <h2>后台管理</h2>
         </div>
         <nav class="sidebar-nav">
           <router-link to="/admin/dashboard" class="nav-item"
             >仪表盘</router-link
           >
           <router-link to="/admin/users" class="nav-item"
             >用户管理</router-link
           >
           <router-link to="/admin/statistics" class="nav-item"
             >系统统计</router-link
           >
         </nav>
       </aside>

       <!-- 主内容区 -->
       <main class="main-content">
         <!-- 顶部导航 -->
         <header class="top-nav">
           <div class="nav-title">
             <h1>用户管理</h1>
           </div>
           <div class="user-info">
             <span class="username">欢迎，管理员</span>
             <button @click="logout" class="logout-btn">退出登录</button>
           </div>
         </header>

         <!-- 搜索和筛选 -->
         <div class="search-container">
           <input
             type="text"
             v-model="searchKeyword"
             placeholder="搜索用户名"
             @input="handleSearch"
           />
         </div>

         <!-- 用户列表 -->
         <div class="users-list">
           <table class="users-table">
             <thead>
               <tr>
                 <th>用户名</th>
                 <th>角色</th>
                 <th>创建时间</th>
                 <th>操作</th>
               </tr>
             </thead>
             <tbody>
               <tr v-for="user in users" :key="user._id">
                 <td>{{ user.username }}</td>
                 <td>
                   <select
                     v-model="user.role"
                     @change="handleRoleChange(user._id, user.role)"
                     :disabled="user.role === 'superAdmin'"
                   >
                     <option value="user">普通用户</option>
                     <option value="admin">管理员</option>
                     <option value="superAdmin">超级管理员</option>
                   </select>
                 </td>
                 <td>{{ formatDate(user.createdAt) }}</td>
                 <td>
                   <button
                     @click="handleDelete(user._id)"
                     class="delete-btn"
                     :disabled="user.role === 'superAdmin'"
                   >
                     删除
                   </button>
                 </td>
               </tr>
             </tbody>
           </table>
         </div>

         <!-- 分页 -->
         <div class="pagination" v-if="total > pageSize">
           <button
             @click="changePage(currentPage - 1)"
             :disabled="currentPage === 1"
           >
             上一页
           </button>
           <span>{{ currentPage }} / {{ totalPages }}</span>
           <button
             @click="changePage(currentPage + 1)"
             :disabled="currentPage === totalPages"
           >
             下一页
           </button>
         </div>
       </main>
     </div>
   </template>

   <script setup>
   import { ref, computed, onMounted } from "vue";
   import { useRouter } from "vue-router";
   import { authService } from "../../services/auth";
   import { getUsers, updateUserRole, deleteUser } from "../../services/admin";

   const router = useRouter();
   const users = ref([]);
   const total = ref(0);
   const currentPage = ref(1);
   const pageSize = ref(10);
   const searchKeyword = ref("");

   // 计算总页数
   const totalPages = computed(() => Math.ceil(total.value / pageSize.value));

   // 格式化日期
   const formatDate = (date) => {
     return new Date(date).toLocaleString("zh-CN");
   };

   // 获取用户列表
   const fetchUsers = async () => {
     try {
       const res = await getUsers({
         page: currentPage.value,
         pageSize: pageSize.value,
         search: searchKeyword.value,
       });
       if (res.code === "0000") {
         users.value = res.data.users;
         total.value = res.data.total;
       }
     } catch (error) {
       console.error("获取用户列表失败:", error);
     }
   };

   // 页面加载时获取数据
   onMounted(() => {
     fetchUsers();
   });

   // 搜索用户
   const handleSearch = () => {
     currentPage.value = 1;
     fetchUsers();
   };

   // 分页
   const changePage = (page) => {
     if (page >= 1 && page <= totalPages.value) {
       currentPage.value = page;
       fetchUsers();
     }
   };

   // 修改用户角色
   const handleRoleChange = async (userId, role) => {
     try {
       await updateUserRole(userId, role);
       alert("角色修改成功");
     } catch (error) {
       console.error("修改角色失败:", error);
       alert("修改角色失败，请重试");
       // 恢复原角色
       fetchUsers();
     }
   };

   // 删除用户
   const handleDelete = async (userId) => {
     if (confirm("确定要删除这个用户吗？")) {
       try {
         await deleteUser(userId);
         alert("用户删除成功");
         fetchUsers();
       } catch (error) {
         console.error("删除用户失败:", error);
         alert("删除用户失败，请重试");
       }
     }
   };

   // 退出登录
   const logout = () => {
     authService.logout();
     router.push("/admin/login");
   };
   </script>

   <style scoped>
   .admin-dashboard {
     display: flex;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .sidebar {
     width: 200px;
     background-color: #304156;
     color: white;
     display: flex;
     flex-direction: column;
   }

   .sidebar-header {
     padding: 20px;
     border-bottom: 1px solid #40556a;
   }

   .sidebar-header h2 {
     margin: 0;
     font-size: 18px;
     font-weight: 600;
   }

   .sidebar-nav {
     flex: 1;
     padding: 20px 0;
   }

   .nav-item {
     display: block;
     padding: 12px 20px;
     color: white;
     text-decoration: none;
     transition: background-color 0.3s;
   }

   .nav-item:hover {
     background-color: #40556a;
   }

   .nav-item.router-link-active {
     background-color: #409eff;
   }

   .main-content {
     flex: 1;
     display: flex;
     flex-direction: column;
   }

   .top-nav {
     background-color: white;
     padding: 0 20px;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
     display: flex;
     justify-content: space-between;
     align-items: center;
     height: 60px;
   }

   .nav-title h1 {
     margin: 0;
     font-size: 20px;
     color: #303133;
   }

   .user-info {
     display: flex;
     align-items: center;
     gap: 16px;
   }

   .username {
     color: #606266;
   }

   .logout-btn {
     background-color: #f56c6c;
     color: white;
     border: none;
     padding: 6px 12px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .logout-btn:hover {
     background-color: #f78989;
   }

   .search-container {
     padding: 20px;
     background-color: white;
     margin: 20px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     text-align: center;
   }

   .search-container input {
     width: 100%;
     max-width: 500px;
     padding: 10px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
   }

   .users-list {
     flex: 1;
     padding: 0 20px 20px;
   }

   .users-table {
     width: 100%;
     border-collapse: collapse;
     background-color: white;
     border-radius: 8px;
     overflow: hidden;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
   }

   .users-table th,
   .users-table td {
     padding: 12px;
     text-align: left;
     border-bottom: 1px solid #ebeef5;
   }

   .users-table th {
     background-color: #f5f7fa;
     font-weight: 600;
     color: #303133;
   }

   .users-table td {
     color: #606266;
   }

   .users-table select {
     padding: 4px 8px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     font-size: 14px;
   }

   .delete-btn {
     background-color: #f56c6c;
     color: white;
     border: none;
     padding: 4px 8px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s;
     font-size: 14px;
   }

   .delete-btn:hover:not(:disabled) {
     background-color: #f78989;
   }

   .delete-btn:disabled {
     background-color: #c0c4cc;
     cursor: not-allowed;
   }

   .pagination {
     display: flex;
     justify-content: center;
     align-items: center;
     gap: 10px;
     margin: 20px 0;
   }

   .pagination button {
     padding: 5px 15px;
     border: 1px solid #dcdfe6;
     border-radius: 4px;
     background-color: white;
     cursor: pointer;
   }

   .pagination button:hover:not(:disabled) {
     background-color: #f5f7fa;
   }

   .pagination button:disabled {
     cursor: not-allowed;
     color: #c0c4cc;
   }
   </style>
   ```

8. 创建`components/pages/SystemStatistics.vue`（系统统计组件）：

   ```vue
   <template>
     <div class="admin-dashboard">
       <!-- 侧边栏 -->
       <aside class="sidebar">
         <div class="sidebar-header">
           <h2>后台管理</h2>
         </div>
         <nav class="sidebar-nav">
           <router-link to="/admin/dashboard" class="nav-item"
             >仪表盘</router-link
           >
           <router-link to="/admin/users" class="nav-item"
             >用户管理</router-link
           >
           <router-link to="/admin/statistics" class="nav-item"
             >系统统计</router-link
           >
         </nav>
       </aside>

       <!-- 主内容区 -->
       <main class="main-content">
         <!-- 顶部导航 -->
         <header class="top-nav">
           <div class="nav-title">
             <h1>系统统计</h1>
           </div>
           <div class="user-info">
             <span class="username">欢迎，管理员</span>
             <button @click="logout" class="logout-btn">退出登录</button>
           </div>
         </header>

         <!-- 统计卡片 -->
         <div class="stats-cards">
           <div class="stat-card">
             <h3>总用户数</h3>
             <p class="stat-value">{{ systemStats.totalUsers }}</p>
           </div>
           <div class="stat-card">
             <h3>总账单数</h3>
             <p class="stat-value">{{ systemStats.totalAccounts }}</p>
           </div>
           <div class="stat-card">
             <h3>日活跃用户</h3>
             <p class="stat-value">{{ systemStats.todayActiveUsers }}</p>
           </div>
         </div>
       </main>
     </div>
   </template>

   <script setup>
   import { ref, onMounted } from "vue";
   import { useRouter } from "vue-router";
   import { authService } from "../../services/auth";
   import { getSystemStatistics } from "../../services/admin";

   const router = useRouter();
   const systemStats = ref({
     totalUsers: 0,
     totalAccounts: 0,
     todayActiveUsers: 0,
   });

   // 获取系统统计数据
   const fetchSystemStats = async () => {
     try {
       const res = await getSystemStatistics();
       if (res.code === "0000") {
         systemStats.value = res.data;
       }
     } catch (error) {
       console.error("获取系统统计数据失败:", error);
     }
   };

   // 页面加载时获取数据
   onMounted(() => {
     fetchSystemStats();
   });

   // 退出登录
   const logout = () => {
     authService.logout();
     router.push("/admin/login");
   };
   </script>

   <style scoped>
   .admin-dashboard {
     display: flex;
     min-height: 100vh;
     background-color: #f5f7fa;
   }

   .sidebar {
     width: 200px;
     background-color: #304156;
     color: white;
     display: flex;
     flex-direction: column;
   }

   .sidebar-header {
     padding: 20px;
     border-bottom: 1px solid #40556a;
   }

   .sidebar-header h2 {
     margin: 0;
     font-size: 18px;
     font-weight: 600;
   }

   .sidebar-nav {
     flex: 1;
     padding: 20px 0;
   }

   .nav-item {
     display: block;
     padding: 12px 20px;
     color: white;
     text-decoration: none;
     transition: background-color 0.3s;
   }

   .nav-item:hover {
     background-color: #40556a;
   }

   .nav-item.router-link-active {
     background-color: #409eff;
   }

   .main-content {
     flex: 1;
     display: flex;
     flex-direction: column;
   }

   .top-nav {
     background-color: white;
     padding: 0 20px;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
     display: flex;
     justify-content: space-between;
     align-items: center;
     height: 60px;
   }

   .nav-title h1 {
     margin: 0;
     font-size: 20px;
     color: #303133;
   }

   .user-info {
     display: flex;
     align-items: center;
     gap: 16px;
   }

   .username {
     color: #606266;
   }

   .logout-btn {
     background-color: #f56c6c;
     color: white;
     border: none;
     padding: 6px 12px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s;
   }

   .logout-btn:hover {
     background-color: #f78989;
   }

   .stats-cards {
     flex: 1;
     padding: 20px;
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 20px;
   }

   .stat-card {
     background-color: white;
     padding: 20px;
     border-radius: 8px;
     box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
     text-align: center;
   }

   .stat-card h3 {
     margin: 0 0 10px 0;
     color: #606266;
     font-size: 16px;
     font-weight: 500;
   }

   .stat-value {
     font-size: 36px;
     font-weight: bold;
     margin: 0;
     color: #303133;
   }
   </style>
   ```

### 4.6 主应用文件

1. 更新`App.vue`：

   ```vue
   <template>
     <router-view />
   </template>
   ```

2. 更新`main.js`，引入路由：

   ```javascript
   import { createApp } from "vue";
   import App from "./App.vue";
   import router from "./router";

   const app = createApp(App);
   app.use(router);
   app.mount("#app");
   ```

### 4.7 测试前端应用

1. 启动前端开发服务器：

   ```bash
   npm run dev
   ```

2. 访问 http://localhost:5173，测试前端功能。

## 5. 整合测试

1. 确保后端服务运行在 http://localhost:3000
2. 确保前端服务运行在 http://localhost:5173
3. 测试完整流程：
   - 用户注册
   - 用户登录
   - 添加账单
   - 查看账单列表
   - 编辑账单
   - 删除账单
   - 查看统计数据
4. 测试管理员功能：
   - 管理员登录（使用具有 admin 或 superAdmin 角色的用户）
   - 查看仪表盘
   - 查看用户管理页面，验证用户按角色排序
   - 修改用户角色（仅 superAdmin 可操作）
   - 删除用户（仅 superAdmin 可操作）
   - 查看系统统计数据

## 6. 部署建议

### 6.1 后端部署

1. 使用 PM2 管理 Node.js 进程：

   ```bash
   npm install pm2 -g
   pm2 start app.js --name account-book-backend
   ```

2. 配置 Nginx 反向代理：

   ```nginx
   server {
     listen 80;
     server_name your_domain.com;

     location /api {
       proxy_pass http://localhost:3000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
     }

     location /api-docs {
       proxy_pass http://localhost:3000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
     }
   }
   ```

### 6.2 前端部署

1. 构建前端项目：

   ```bash
   npm run build
   ```

2. 将`dist`目录部署到 Nginx 或其他静态文件服务器：

   ```nginx
   server {
     listen 80;
     server_name your_domain.com;

     location / {
       root /path/to/your/dist;
       index index.html;
       try_files $uri $uri/ /index.html;
     }
   }
   ```

## 7. 扩展功能建议

1. 实现账单导入/导出功能
2. 添加更多统计图表，如收支趋势图
3. 支持多币种
4. 添加预算管理功能
5. 实现数据备份和恢复功能
6. 添加社交分享功能
7. 实现邮件通知功能
8. 添加数据可视化大屏
9. 实现多语言支持
10. 添加用户行为分析

## 8. 常见问题及解决方案

1. **MongoDB 连接失败**：
   - 检查 MongoDB 服务是否正在运行
   - 检查连接字符串是否正确
   - 检查防火墙设置

2. **跨域问题**：
   - 确保后端已配置 CORS 中间件
   - 检查前端 API 请求地址是否正确

3. **JWT 验证失败**：
   - 检查 token 是否过期
   - 检查 secret 是否一致
   - 检查 token 格式是否正确

4. **前端页面白屏**：
   - 检查浏览器控制台是否有错误
   - 检查路由配置是否正确
   - 检查 API 请求是否成功

5. **图表不显示**：
   - 检查 ECharts 是否正确引入
   - 检查图表容器是否存在
   - 检查数据格式是否正确

## 9. 学习资源推荐

1. **Vue 3 官方文档**：https://v3.vuejs.org/
2. **Express 官方文档**：https://expressjs.com/
3. **MongoDB 官方文档**：https://docs.mongodb.com/
4. **Mongoose 官方文档**：https://mongoosejs.com/
5. **JWT 官方文档**：https://jwt.io/
6. **ECharts 官方文档**：https://echarts.apache.org/

## 总结

通过本教程，你已经学会了如何使用 Vue 3 + Express + MongoDB + JWT 开发一个完整的前后端分离记账本应用。从环境搭建到数据库设计，从 API 开发到前端组件实现，你已经掌握了现代 Web 应用开发的核心技能。

建议你按照教程步骤一步步实现，遇到问题时查阅相关文档或搜索解决方案。随着你对技术的深入理解，可以尝试扩展更多功能，不断完善你的记账本应用。

祝你学习愉快，开发顺利！
